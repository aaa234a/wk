<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>履歴</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="sidebar">
      <a href="/">← ホーム</a><br />
      <a id="editlink">編集ページへ</a><br />
    </div>

    <div id="content">
      <h1>ページ履歴</h1>
      <div id="historyBox"></div>
    </div>

    <script>
      async function loadHistory() {
        const url = new URL(location.href);
        const name = url.searchParams.get("page");
        if (!name) return;
        editlink.href = "/edit.html?page=" + encodeURIComponent(name);

        const d = await fetch(
          "/api/page?name=" + encodeURIComponent(name)
        ).then((r) => r.json());
        if (!d.page || !d.page.history) return;

        const box = document.getElementById("historyBox");
        const users = await fetch("/api/users").then((r) => r.json());

        d.page.history
          .slice()
          .reverse()
          .forEach((h) => {
            const user = users.find((u) => u.name === h.ip);
            const icon = user ? user.icon : "";
            const div = document.createElement("div");
            div.className = "history-box";
            const date = new Date(h.time).toLocaleString();
            // Wiki記法変換
            let html = h.raw
              .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
              .replace(/\*(.*?)\*/g, "<i>$1</i>")
              .replace(/__(.*?)__/g, "<u>$1</u>")
              .replace(/~~(.*?)~~/g, "<del>$1</del>")
              .replace(/### (.*)/g, "<h3>$1</h3>")
              .replace(/## (.*)/g, "<h2>$1</h2>");

            div.innerHTML = `<img src="${icon}" class="user-icon"><div><b>編集者:</b> ${h.masked} | <b>日時:</b> ${date}</div><div>${html}</div>`;
            box.appendChild(div);
          });
      }
      loadHistory();
    </script>
  </body>
</html>
