<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ユーザー編集</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="sidebar">
      <a href="/">← ホーム</a>
    </div>

    <div id="content">
      <h1>ユーザー編集</h1>

      <label>ユーザー名 (Mツイユーザー名)</label><br />
      <input id="username" style="width: 300px" /><br /><br />

      <div>
        <button onclick="wrapTag('**')"><b>B</b></button>
        <button onclick="wrapTag('*')"><i>I</i></button>
        <button onclick="wrapTag('__')"><u>U</u></button>
        <button onclick="wrapTag('~~')"><del>DEL</del></button>
      </div>

      <label>説明 (Wiki記法)</label><br />
      <textarea id="body" style="width: 100%; height: 200px"></textarea
      ><br /><br />

      <label>アイコンURL</label><br />
      <input id="iconURL" style="width: 300px" /><br /><br />

      <button id="savebtn">保存</button>
    </div>

    <script>
      function wrapTag(tag) {
        const textarea = document.getElementById("body");
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selected = textarea.value.substring(start, end);
        textarea.setRangeText(tag + selected + tag, start, end, "end");
      }

      async function load() {
        const url = new URL(location.href);
        const uname = url.searchParams.get("username");
        if (!uname) return;
        username.value = uname;
        const d = await fetch(
          "/api/user?username=" + encodeURIComponent(uname)
        ).then((r) => r.json());
        if (d.user) {
          body.value = d.user.body || "";
          iconURL.value = d.user.iconURL || "";
        }
      }
      load();

      savebtn.onclick = async () => {
        const uname = username.value.trim();
        if (!uname) return alert("ユーザー名必須");
        const res = await fetch("/api/edit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            username: uname,
            body: body.value,
            iconURL: iconURL.value,
          }),
        }).then((r) => r.json());
        if (res.error) alert(res.error);
        else location.href = "/view.html?username=" + encodeURIComponent(uname);
      };
    </script>
  </body>
</html>
